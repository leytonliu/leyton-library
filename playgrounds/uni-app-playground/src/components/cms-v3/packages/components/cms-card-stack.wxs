/* eslint-disable no-unused-vars */
/*
 * @Author: shuyan.yin@hand-china.com
 * @Date: 2023-12-22 11:09:47
 * @LastEditTime: 2023-12-22 14:51:09
 * @LastEditors: shuyan.yin@hand-china.com
 * @Description: WXS 好像不太认识 ES2015 之后的语法, 也许写这个功能的 TX 员工是穿越来的
 * @FilePath: \o2-b2c-mall\src\components\cms\packages\components\cms-card-stack.wxs
 */

var VERTICAL = 101;
var HORIZONTAL = 102;

/**
 * 开始触摸操作
 * @param {Object} e
 * @param {Object} ins
 */
function touchstart(e, ownerInstance) {
  var instance = e.instance;
  var state = instance.getState();
  state.x = e.touches[0].clientX;
  state.y = e.touches[0].clientY;
  state.isVOH = null;
  instance.callMethod('onTouchStart', e);
}

/**
 * 开始滑动操作
 * @param {Object} e
 * @param {Object} ownerInstance
 */
function touchmove(e, ownerInstance) {
  var instance = e.instance;
  var state = instance.getState();
  var thresholdX = 40;
  var thresholdY = 30;

  if (!state.isVOH) {
    // console.log('onTouchMove', '判断 isVOH');
    var moveX = e.touches[0].clientX;
    var moveY = e.touches[0].clientY;
    var diffX = Math.abs(moveX - state.x);
    var diffY = Math.abs(moveY - state.y);
    // console.log('onTouchMove', 'moveX', moveX, 'moveY', moveY);
    console.log('onTouchMove', 'diffX', diffX, 'diffY', diffY);
    if (diffY > thresholdY && diffY > diffX) state.isVOH = VERTICAL;
    else if (diffX > thresholdX) state.isVOH = HORIZONTAL;
  }

  instance.callMethod('onTouchMove', { changedTouches: e.changedTouches, touches: e.touches, isVOH: state.isVOH });

  // console.log('onTouchMove', 'isVOH', state.isVOH);
  if (state.isVOH === HORIZONTAL || !state.isVOH) {
    console.log('onTouchMove 阻止页面滚动');
    // if (e.preventDefault) {
    //   e.preventDefault(); // 阻止页面滚动
    // }
    return false;
  }
}
/**
 * IOS 上的滑动操作有个特殊逻辑，如果第一次触发的 touchmove 阻止了默认行为，则后续皆不会触发默认滑动行为
 * @param {Object} e
 * @param {Object} ownerInstance
 */
function IOSTouchmove(e, ownerInstance) {
  var instance = e.instance;
  var state = instance.getState();

  if (!state.isVOH) {
    var moveX = e.touches[0].clientX;
    var moveY = e.touches[0].clientY;
    var diffX = Math.abs(moveX - state.x);
    var diffY = Math.abs(moveY - state.y);
    console.log('IOSTouchmove', 'diffX', diffX, 'diffY', diffY);
    if (diffY > diffX) state.isVOH = VERTICAL;
    else state.isVOH = HORIZONTAL;
  }

  instance.callMethod('onTouchMove', { changedTouches: e.changedTouches, touches: e.touches, isVOH: state.isVOH });

  if (state.isVOH === HORIZONTAL) {
    console.log('IOSTouchmove 阻止页面滚动');
    return false;
  }
}

module.exports = { touchstart: touchstart, touchmove: touchmove, IOSTouchmove: IOSTouchmove };
